# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Kubernetes homelab cluster template based on Talos Linux with GitOps workflows using Flux. The project uses template-driven configuration through `makejinja` to generate Kubernetes and Talos manifests from YAML configuration files (`cluster.yaml` and `nodes.yaml`).

Key technologies:
- **Talos Linux**: Immutable Kubernetes OS
- **Flux**: GitOps continuous delivery
- **Cilium**: CNI and networking
- **Cloudflare**: DNS and tunnel ingress
- **SOPS + Age**: Secret encryption
- **Envoy Gateway**: Internal/external HTTP routing
- **Task**: Task automation (via Taskfile.yaml)
- **Mise**: Development environment/tool management

## Development Environment Setup

All required CLI tools are managed via Mise:

```sh
mise trust
pip install pipx
mise install
```

Required tools include: talosctl, kubectl, flux, helm, sops, age, cilium-cli, cloudflared, talhelper, makejinja, cue, and more.

## Common Commands

### Initial Setup

```sh
# Initialize config files (creates cluster.yaml, nodes.yaml, age.key, deploy keys)
task init

# Configure and template all manifests (renders templates, encrypts secrets, validates configs)
task configure
```

### Bootstrap Cluster

```sh
# Bootstrap Talos on bare metal/VMs
task bootstrap:talos

# Bootstrap applications (Cilium, CoreDNS, Spegel, Flux)
task bootstrap:apps
```

### Flux Operations

```sh
# Force Flux to reconcile Git repository
task reconcile

# Check Flux status
flux check
flux get sources git -A
flux get ks -A
flux get hr -A
```

### Talos Operations

```sh
# Generate Talos config after changes
task talos:generate-config

# Apply config to specific node
task talos:apply-node IP=10.0.0.10 MODE=auto

# Upgrade Talos on node
task talos:upgrade-node IP=10.0.0.10

# Upgrade Kubernetes version
task talos:upgrade-k8s

# Reset cluster to maintenance mode (destructive)
task talos:reset
```

### Debugging

```sh
# Gather common cluster resources
task template:debug

# Check pod status
kubectl get pods --all-namespaces --watch

# Check Cilium status
cilium status

# Check certificates
kubectl -n kube-system describe certificates
```

### Template Operations

```sh
# Archive template files after initial setup
task template:tidy

# Remove all templated files (destructive)
task template:reset
```

## Architecture

### Configuration Flow

1. **Source configs**: `cluster.yaml` and `nodes.yaml` define cluster parameters
2. **Template rendering**: `makejinja` processes `templates/` directory using Python plugins
3. **Output directories**:
   - `bootstrap/`: Initial bootstrap manifests
   - `kubernetes/`: Flux GitRepository, Kustomizations, HelmReleases organized by namespace
   - `talos/`: Talos machine configurations (via talhelper)
4. **Secret encryption**: SOPS encrypts `*.sops.*` files using Age key
5. **Validation**: kubeconform validates Kubernetes manifests, talhelper validates Talos configs

### Directory Structure

- `.taskfiles/`: Task definitions for bootstrap, talos, and template operations
- `bootstrap/`: Bootstrap resources applied before Flux sync
- `kubernetes/apps/`: Application HelmReleases and Kustomizations (generated)
- `kubernetes/flux/`: Flux system configuration (generated)
- `talos/`: Talos machine configs via talhelper (generated)
- `templates/`: Jinja2 templates for generating configs
- `scripts/`: Helper scripts (bootstrap-apps.sh, etc.)

### Gateway Architecture

Two Envoy gateways provide traffic ingress:
- `envoy-internal`: Private network access (uses k8s_gateway for DNS)
- `envoy-external`: Public internet access via Cloudflare Tunnel (uses external-dns)

Applications expose services via HTTPRoutes attached to the appropriate gateway.

### Secret Management

Secrets are encrypted with SOPS using Age encryption:
- Age key: `age.key` (generated by `task init`)
- SOPS config: `.sops.yaml` (generated during `task configure`)
- Encrypted files: `*.sops.yaml` or `*.sops.json`
- Flux decrypts secrets automatically via kustomize-controller

### Bootstrap Process

1. Talos installed on bare metal/VMs from Image Factory ISO
2. `task bootstrap:talos` generates and applies Talos configs, creates cluster
3. `task bootstrap:apps` applies core components:
   - Cilium (CNI)
   - CoreDNS
   - Spegel (image mirror)
   - Flux (GitOps)
4. Flux syncs `kubernetes/` directory and reconciles all HelmReleases/Kustomizations

## Important Constraints

- **SOPS key location**: Do NOT have `~/.config/sops/age/keys.txt` - it conflicts with repository age key
- **Docker registry logout**: Must logout of GHCR before bootstrap to avoid auth issues
- **Bash version**: macOS requires Homebrew bash (`brew install bash`) for scripts
- **Repository visibility**: If private, must add `github-deploy.key.pub` as deploy key
- **Network requirements**: Cloudflare account with domain and API token required
- **Minimum nodes**: 3 controller nodes recommended for HA (4 cores, 16GB RAM, 256GB disk each)

## Configuration Files

- `cluster.yaml`: Cluster-wide settings (network CIDRs, gateways, Cloudflare domain, GitHub repo)
- `nodes.yaml`: Node definitions (name, IP, disk, MAC address, schematic ID, controller role)
- `talenv.yaml`: Talos and Kubernetes versions (in `talos/` directory, generated)
- `.mise.toml`: Tool versions for development environment
- `.renovaterc.json5`: Renovate dependency update configuration

## Testing & Validation

The template includes schema validation via CUE:
- Cluster config validated against `.taskfiles/template/resources/cluster.schema.cue`
- Node config validated against `.taskfiles/template/resources/nodes.schema.cue`
- Kubernetes manifests validated via kubeconform
- Talos configs validated via talhelper

## Post-Bootstrap Operations

After `task template:tidy`, the following are archived to `.private/<timestamp>/`:
- `templates/` directory
- `makejinja.toml`
- `cluster.yaml` and `nodes.yaml`
- Template taskfile entries

This removes template clutter and eliminates Renovate "duplicate registry" warnings.
